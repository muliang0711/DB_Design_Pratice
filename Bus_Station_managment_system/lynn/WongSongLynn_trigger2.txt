CREATE OR REPLACE TRIGGER ManagePointTransaction
BEFORE INSERT OR UPDATE ON PointTransaction
FOR EACH ROW
DECLARE
    v_currentBalance NUMBER(5);
    v_paymentStatus VARCHAR2(20);
    v_paymentAmount NUMBER(8,2);
    v_pointsUsed NUMBER(5);
BEGIN
    -- For point redemption (positive pointChange: redeem,consumption deduction)
    IF :NEW.pointChange > 0 THEN
        -- Get current balance
        SELECT pointBalance 
        INTO v_currentBalance
        FROM Customer
        WHERE customerID = :NEW.customerID;
        
        -- Check if enough points
        IF (v_currentBalance - :NEW.pointChange) < 0 THEN
            RAISE_APPLICATION_ERROR(-20003, 'Insufficient points for this transaction');
        END IF;
        
        -- If related to payment, validate payment status
        IF :NEW.paymentID IS NOT NULL THEN
            SELECT status, pointsApplied, totalAmount INTO v_paymentStatus, v_pointsUsed, v_paymentAmount
            FROM PaymentRecord
            WHERE paymentID = :NEW.paymentID;
            
            IF UPPER(v_paymentStatus) != 'COMPLETED' THEN
                RAISE_APPLICATION_ERROR(-20004, 'Points can only be applied to completed payments');
            END IF;
            
            -- Verify points used match payment record
            IF :NEW.pointChange != v_pointsUsed THEN
                RAISE_APPLICATION_ERROR(-20005, 'Point transaction does not match payment record');
            END IF;
        END IF;
    END IF;
    
    -- Update customer point balance
    UPDATE Customer
    SET pointBalance = pointBalance + :NEW.pointChange,
        updatedAt = SYSDATE
    WHERE customerID = :NEW.customerID;
END;
/
-- redeemtion cannot > customer own
-- redeemtion only after the payment is done


-- use
INSERT INTO PaymentRecord (paymentId, customerId, ticketId, totalAmount, cashAmount, pointsApplied, pointValue, status, paymentTime, receiptNo, paymentMethod, type)
VALUES ('P001', 'CU0003', 'T00000000200', 200, 170, 30, 30, 'Completed', SYSTIMESTAMP, 'R001', 'Cash', 'Ticket');

INSERT INTO PointTransaction (pointTxnId, customerId, paymentId, pointChange, source, remarks)
VALUES ('PT001', 'CU0003', 'P001', 30, 'Payment Redeem', 'Used points for ticket payment');

--invalid  example
INSERT INTO PointTransaction (pointTxnId, customerId, paymentId, pointChange, source, remarks)
VALUES ('PT001', 'CU0003', 'P001', 1140, 'Payment Redeem', 'Used points for ticket payment');

INSERT INTO PointTransaction (pointTxnId, customerId, paymentId, pointChange, source, remarks)
VALUES ('PT001', 'CU0003', 'P001', 40, 'Payment Redeem', 'Used points for ticket payment');

INSERT INTO PointTransaction (pointTxnId, customerId, paymentId, pointChange, source, remarks)
VALUES ('PT002', 'CU0002', 'P001', 50, 'Payment Redeem', 'Trying to use more points');
