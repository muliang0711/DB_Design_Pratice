
SET serveroutput on
SET linesize 120
SET pagesize 100
CREATE OR REPLACE PROCEDURE ExtendTicket(
    p_ticketID      IN Ticket.ticketID%TYPE,
    p_newScheduleID IN BusSchedule.busScheduleID%TYPE
    
)
AS
    v_originalScheduleID    Ticket.busScheduleID%TYPE;
    v_originalRouteID       route.routeID%TYPE;
    v_newRouteID            route.routeID%TYPE;
    v_originalDepartureTime BusSchedule.plannedDepartureTime%TYPE;
    v_newDepartureTime      BusSchedule.plannedDepartureTime%TYPE;
    v_currentStatus         Ticket.status%TYPE;
    v_daysBeforeDeparture   NUMBER;
    v_result                VARCHAR2(100);
BEGIN
    -- Original schedule information
    SELECT t.busScheduleId, t.status,r.routeId, bs.plannedDepartureTime
    INTO v_originalScheduleID, v_currentStatus, v_originalRouteID, v_originalDepartureTime
    FROM ticket t
    JOIN busSchedule bs ON t.busScheduleId = bs.busScheduleId
    JOIN routeDriverAssignmentList rda ON bs.routeDriverAssignmentId = rda.routeDriverAssignmentId
    JOIN route r ON rda.routeId = r.routeId
    WHERE t.ticketId = p_ticketID;

    -- new schedule information
    SELECT r.routeId, bs.plannedDepartureTime
    INTO v_newRouteID, v_newDepartureTime
    FROM busSchedule bs
    JOIN routeDriverAssignmentList rda ON bs.routeDriverAssignmentId = rda.routeDriverAssignmentId
    JOIN route r ON rda.routeId = r.routeId
    WHERE bs.busScheduleId = p_newScheduleID;

    -- calculate departure days
    v_daysBeforeDeparture := TRUNC(v_originalDepartureTime)- TRUNC(SYSDATE);

    -- check the status
    IF v_currentStatus != 'booked' THEN
        v_result := 'Error: Only booked tickets can be extended';
        RETURN;
    END IF;

    -- check the route and extention (the customer only can change the time not the route )
    IF v_originalRouteID = v_newRouteID THEN
        IF v_daysBeforeDeparture BETWEEN 0 AND 2 THEN
            UPDATE ticket
            SET status = 'booked_extended',
                extendedToID = p_newScheduleID,
                extensionDate = SYSTIMESTAMP,
                updatedAt = SYSTIMESTAMP
            WHERE ticketId = p_ticketID;

            v_result := 'Success: Ticket extended to new schedule';
        ELSE
            v_result := 'Error: Extension only allowed within 2 days before departure';
        END IF;
    ELSE
        v_result := 'Error: New schedule must be on the same route';
    END IF;

    COMMIT;
    DBMS_OUTPUT.PUT_LINE(v_result);

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        v_result := 'Error: ' || SQLERRM;
        DBMS_OUTPUT.PUT_LINE(v_result);
END ExtendTicket;
/
EXEC ExtendTicket('T00000281318', 'S2PP4VEFOV0L');
