CREATE OR REPLACE PROCEDURE prcShowRentals IS
  v_shopID  Shop.shopID%TYPE;
  v_staffID RentalCollection.staffID%TYPE;
  v_amount  RentalCollection.rentalAmount%TYPE;
  v_status  RentalCollection.status%TYPE;
  v_rentalMonth RentalCollection.rentalMonth%TYPE;
  v_collectionDate RentalCollection.collectionDate%TYPE;
  v_total   NUMBER;
  v_count   NUMBER;

  CURSOR shopCursor IS
    SELECT shopID
    FROM Shop
    WHERE status = 'active'
    ORDER BY shopID;

  CURSOR rentCursor(p_shopID Shop.shopID%TYPE) IS
     SELECT rentalMonth, staffID, rentalAmount, status, collectionDate
     FROM RentalCollection
     WHERE shopID = p_shopID
     ORDER BY collectionDate;

BEGIN
  OPEN shopCursor;
  LOOP
    FETCH shopCursor INTO v_shopID;
    EXIT WHEN shopCursor%NOTFOUND;

    v_total := 0;
    v_count := 0;

    DBMS_OUTPUT.PUT_LINE(CHR(10));
    DBMS_OUTPUT.PUT_LINE(LPAD('=', 71, '='));
    DBMS_OUTPUT.PUT_LINE('Shop Rental Record for Shop ID: ' || v_shopID);
    DBMS_OUTPUT.PUT_LINE(LPAD('=', 71, '='));
        DBMS_OUTPUT.PUT_LINE(
        RPAD('Staff ID', 12) ||
        RPAD('Amount', 10) ||
        RPAD('Rental Month', 15) ||
        RPAD('Status', 12) ||
        RPAD('Paid At', 15)
    );
    DBMS_OUTPUT.PUT_LINE(RPAD('-', 71, '-'));

    BEGIN
      OPEN rentCursor(v_shopID);
      LOOP
        FETCH rentCursor INTO v_rentalMonth, v_staffID, v_amount, v_status, v_collectionDate;
        EXIT WHEN rentCursor%NOTFOUND;

        IF LOWER(v_status) = 'paid' THEN
          v_total := v_total + v_amount;
        END IF;

        v_count := v_count + 1;

        DBMS_OUTPUT.PUT_LINE(
          (NVL(v_staffID, 'unknown')) ||
          RPAD(NVL(TO_CHAR(v_amount, '$9,999.00'), '$0.00'), 15) ||
          RPAD(TO_CHAR(v_rentalMonth, 'YYYY-MM'), 15) ||
          RPAD(v_status, 12) ||
          RPAD(NVL(TO_CHAR(v_collectionDate, 'YYYY-MM-DD'), '-'), 15)
        );
      END LOOP;
      CLOSE rentCursor;
    END;

    IF v_count = 0 THEN
      DBMS_OUTPUT.PUT_LINE('No rental records found for Shop ID: ' || v_shopID);
    ELSE
      DBMS_OUTPUT.PUT_LINE(RPAD('-', 71, '-'));
      DBMS_OUTPUT.PUT_LINE('Total Records: ' || v_count);
      DBMS_OUTPUT.PUT_LINE('Total Collected: ' || (NVL(TO_CHAR(v_total, '$999,999.00'), '$0.00')));
    END IF;
  END LOOP;
  CLOSE shopCursor;

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Error occurred: ' || SQLERRM);
END;
/

-- exec prcShowRentals



