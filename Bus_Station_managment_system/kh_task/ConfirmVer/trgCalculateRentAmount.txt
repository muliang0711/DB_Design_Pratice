CREATE OR REPLACE TRIGGER trgCalculateRentAmount
BEFORE INSERT OR UPDATE ON RentalCollection
FOR EACH ROW
DECLARE
  v_shopSize Shop.shopSize%TYPE;
  v_count      NUMBER;
  v_countStaff NUMBER;
BEGIN
  IF INSERTING THEN
    SELECT shopSize INTO v_shopSize
    FROM Shop
    WHERE shopID = :NEW.shopID;

    :NEW.rentalAmount := v_shopSize * 2;

  ELSIF UPDATING THEN
    IF :NEW.staffId IS NOT NULL THEN
    SELECT COUNT(*) INTO v_count
    FROM staff st
    JOIN staffRole sr ON st.roleId = sr.roleId
    WHERE st.staffId = :NEW.staffId
    AND LOWER(sr.roleName) = 'accountant';

    IF v_count = 0 THEN
      RAISE_APPLICATION_ERROR(-20011,
        'Error: StaffId ' || :NEW.staffId || ' is not a valid Accountant in Staff table.');
    END IF;
    END IF;

    IF LOWER(:NEW.status) = 'paid'
       AND LOWER(NVL(:OLD.status, '')) != 'paid' THEN
       
       :NEW.collectionDate := SYSTIMESTAMP;

       SELECT COUNT(*) INTO v_count
       FROM Staff
       WHERE staffId = :NEW.staffId
    ;

       IF v_count = 0 THEN
           RAISE_APPLICATION_ERROR(-20002, 'Error: StaffId ' || :NEW.staffId || ' does not exist in Staff table.');
       END IF;
    END IF;
  END IF;
END;
/





