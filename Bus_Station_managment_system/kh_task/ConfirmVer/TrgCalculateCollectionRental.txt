CREATE OR REPLACE TRIGGER trg_set_timeStamp
BEFORE INSERT OR UPDATE ON RentalCollection
FOR EACH ROW
DECLARE
  v_shopSize Shop.shopSize%TYPE;
  v_count      NUMBER;
BEGIN
  IF INSERTING THEN
    SELECT shopSize INTO v_shopSize
    FROM Shop
    WHERE shopID = :NEW.shopID;

    :NEW.rentalAmount := v_shopSize * 2;

  ELSIF UPDATING THEN
    IF LOWER(:NEW.status) = 'paid'
       AND LOWER(NVL(:OLD.status, '')) != 'paid' THEN
       
       :NEW.collectionDate := SYSTIMESTAMP;

       SELECT COUNT(*) INTO v_count
       FROM Staff
       WHERE staffId = :NEW.staffId
    ;

       IF v_count = 0 THEN
           RAISE_APPLICATION_ERROR(-20002, 'Error: StaffId ' || :NEW.staffId || ' does not exist in Staff table.');
       END IF;
    END IF;
  END IF;
END;
/



