CREATE OR REPLACE PROCEDURE prcAddRentalCollection IS
  CURSOR shop_cursor IS
    SELECT shopID
    FROM Shop
    WHERE LOWER(status) = 'active';

  v_shopID   Shop.shopID%TYPE;
  v_exists   NUMBER;
BEGIN
  FOR shop_rec IN shop_cursor LOOP
    v_shopID := shop_rec.shopID;

    SELECT COUNT(*) INTO v_exists
    FROM RentalCollection
    WHERE shopID = v_shopID
      AND (
            TRUNC(rentalMonth, 'MM') = TRUNC(SYSDATE, 'MM')
            AND TRUNC(rentalMonth, 'YYYY') = TRUNC(SYSDATE, 'YYYY')
          );

    IF v_exists = 0 THEN
      INSERT INTO RentalCollection (
        rentalMonth, shopId, staffId, rentalAmount, status, collectionDate
      ) VALUES (
        SYSDATE, v_shopID, NULL, NULL, 'unpaid', NULL
      );
    ELSE
      RAISE_APPLICATION_ERROR(-20001,
        'Rental collection record already exists in month: ' || TO_CHAR(SYSDATE, 'YYYY-MM'));
    END IF;
  END LOOP;

  COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Unexpected error: ' || SQLERRM);
END;
/

/*
UPDATE rentalCollection
SET status = 'paid', staffId = 'ST0016'
WHERE shopId = 'SH0159'
  AND TRUNC(rentalMonth, 'MM') = TO_DATE('08/2025', 'MM/YYYY');

SELECT 
    st.staffId,
    st.firstName,
    st.lastName,
    sr.roleName
FROM staff st
JOIN staffRole sr 
    ON st.roleId = sr.roleId
WHERE LOWER(sr.roleName) = 'accountant'
ORDER BY st.staffId;
*/
-- exec prcAddRentalCollection


