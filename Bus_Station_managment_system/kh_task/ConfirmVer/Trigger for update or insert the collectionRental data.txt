CREATE OR REPLACE TRIGGER trg_set_timeStamp
BEFORE INSERT OR UPDATE ON RentalCollection
FOR EACH ROW
DECLARE
  v_shopSize Shop.shopSize%TYPE;
BEGIN
  IF INSERTING THEN
    SELECT shopSize INTO v_shopSize
    FROM Shop
    WHERE shopID = :NEW.shopID;

    :NEW.rentalAmount := v_shopSize * 2;

  ELSIF UPDATING THEN
    IF LOWER(:NEW.status) = 'paid'
       AND LOWER(NVL(:OLD.status, '')) != 'paid' THEN
       
       :NEW.collectionDate := SYSTIMESTAMP;

       IF :NEW.staffID IS NULL THEN
         :NEW.staffID := USER;  -- note: USER returns Oracle username
       END IF;
    END IF;
  END IF;
END;
/
