CREATE OR REPLACE PROCEDURE prcAddRentalCollection(
  v_month   	 IN DATE DEFAULT TRUNC(SYSDATE, 'YYYY-MM')
) IS

 CURSOR shop_cursor IS
    SELECT shopID
    FROM Shop
    WHERE LOWER(status) = 'active';

v_shopID   Shop.shopID%TYPE;
  v_exists   NUMBER;
BEGIN
  FOR shop_rec IN shop_cursor LOOP
    v_shopID := shop_rec.shopID;

 SELECT COUNT(*) INTO v_exists
    FROM RentalCollection
    WHERE shopID = v_shopID
    AND TRUNC(rentalMonth, 'YYYY-MM') = TRUNC(v_month, 'YYYY-MM');

   IF v_exists = 0 THEN
      INSERT INTO RentalCollection (
        rentalMonth, shopId, staffId, rentalAmount, status, createdAt, collectionDate
      ) VALUES (
        v_month, v_shopID, null, null, 'unpaid', SYSTIMESTAMP, null
      );
     ELSE
      RAISE_APPLICATION_ERROR(-20001,
        'Rental collection record already exists for ShopID: ' || v_shopID ||
        ' in month ' || TO_CHAR(v_month, 'YYYY-MM'));
  END IF;
END LOOP

COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Unexpected error: ' || SQLERRM);
END;
/




